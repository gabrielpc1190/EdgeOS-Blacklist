#Firewall rules to run before script is created

set firewall group network-group countries_allowed description 'Allowed countries'
set firewall group network-group countries_allowed network 10.0.0.0/8

set port-forward rule 4 description 'Home Assistant'
set port-forward rule 4 forward-to address 192.168.1.10
set port-forward rule 4 forward-to port 8123
set port-forward rule 4 original-port 8123
set port-forward rule 4 protocol tcp

set firewall name WAN_IN rule 40 action accept
set firewall name WAN_IN rule 40 description 'Home Assistant'
set firewall name WAN_IN rule 40 destination port 8123
set firewall name WAN_IN rule 40 protocol tcp
set firewall name WAN_IN rule 40 source group network-group countries_allowed

set system task-scheduler task country_load interval 1d
set system task-scheduler task country_load executable path /config/scripts/post-config.d/country-load.sh

commit; save

#Create this script file ‚Äú/config/scripts/post-config.d/country-load.sh‚Äù (chmod 755):

#!/bin/bash
#Set the country two digits code ALL-IN-CAPS
countryList="US"
firewallGroupName=countries_allowed

#mkdir /config/user-data
function loadcountry () {
        firewallGroupName=$1
        country=$2

        echo "Downloading country definition for $country..." >> /var/log/country-load
        curl -o /config/user-data/${country}.cidr http://www.iwik.org/ipcountry/${country}.cidr
        echo "Adding rules to firewall group $firewallGroupName..." >> /var/log/country-load
        for rule in `cat /config/user-data/${country}.cidr`; do
                ipset add $firewallGroupName $rule
        done
}

ipset -F $firewallGroupName
for country in $countryList; do
        loadcountry $firewallGroupName $country
done


#This script will run when the Edgerouter boots. It will:
#Traverse the list of countries defined in the top of the script
#Download a list of subnets in each country
#Add it to the ipset table (thats what the Edgerouter uses for network-groups)

#Testing
#After rebooting the edgerouter or manually running the script, you can check that we #actually got some subnets in our network-group:

ipset -L countries_allowed
#Dont be fooled by looking in the GUI ‚Äì it will know nothing about all this happening behind #the scenes!
#Be careful!
#If you do any change to the network group ‚Äúcountries_allowed‚Äù from the GUI, the Edgerouter #will empty the list generated from the script! Don‚Äôt do that üôÇ
